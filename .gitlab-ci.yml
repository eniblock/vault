image: docker:19.03.10

stages:
  - publish

services:
  - docker:dind

variables:
  CONTAINER_REF_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  CONTAINER_SHA_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  CONTAINER_REF_SHA_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA

publish-docker:
  stage: publish
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --pull
      -t $CONTAINER_REF_IMAGE
      -t $CONTAINER_SHA_IMAGE
      -t $CONTAINER_REF_SHA_IMAGE
      .
    - docker push $CONTAINER_REF_IMAGE
    - docker push $CONTAINER_SHA_IMAGE
    - docker push $CONTAINER_REF_SHA_IMAGE

publish-helm:
  stage: publish
  image:
    name: alpine/helm:3.5.2
    entrypoint: ["/bin/sh", "-c"]
  variables:
    HELM_EXPERIMENTAL_OCI: 1
    HELM_IMAGE: $CI_REGISTRY_IMAGE/helm/vault:1.0.2
  script:
    - helm registry login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - helm chart save ./helm/vault $HELM_IMAGE
    - helm chart push $HELM_IMAGE